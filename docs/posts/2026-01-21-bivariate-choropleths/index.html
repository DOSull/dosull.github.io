<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="David O’Sullivan">
<meta name="dcterms.date" content="2026-01-21">
<meta name="description" content="I still have reservations about the usability of bivariate choropleth maps, but at least it’s now a lot easier to make them!">

<title>Bivariate choropleths are go! – Geospatial Stuff</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//images/gs-logo-corrected.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-cf7929f4d66a2bdccc4ecf0c4d40c672.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-966425127c30269e34501eb621c74349.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script defer="" src="https://cloud.umami.is/script.js" data-website-id="06075b90-0666-47f4-af54-6e7b8f59e570" data-domains="geospatialstuff.com"></script>
<meta name="keywords" content="geospatial, R, python, simulation, cartography, visualization, spatial analysis, complexity, training">


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Bivariate choropleths are go! – Geospatial Stuff">
<meta property="og:description" content="I still have reservations about the usability of bivariate choropleth maps, but at least it’s now a lot easier to make them!">
<meta property="og:image" content="https://geospatialstuff.com/posts/2026-01-21-bivariate-choropleths/bivariate-palettes.png">
<meta property="og:site_name" content="Geospatial Stuff">
<meta property="og:image:height" content="912">
<meta property="og:image:width" content="864">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/gs-logo-corrected.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Geospatial Stuff</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../portfolio.html"> 
<span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../contact.html"> 
<span class="menu-text">Contact</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../training.html"> 
<span class="menu-text">Training</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-more" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">More</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-more">    
        <li>
    <a class="dropdown-item" href="../../books.html">
 <span class="dropdown-text">Books</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../presentations.html">
 <span class="dropdown-text">Presentations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../publications.html">
 <span class="dropdown-text">Publications</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://geospatialstuff.com/computing-geographically" target="_blank"><i class="bi bi-box-arrow-up-right" role="img">
</i> 
 <span class="dropdown-text">Computing Geographically</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://geospatialstuff.com/pattern-and-process" target="_blank"><i class="bi bi-box-arrow-up-right" role="img">
</i> 
 <span class="dropdown-text">Spatial Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://geospatialstuff.com/30-day-maps-2023" target="_blank"><i class="bi bi-box-arrow-up-right" role="img">
</i> 
 <span class="dropdown-text">30 Day Map Challenge 2023&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/david-o-sullivan-1b8a901b7/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bivariate choropleths are go!</h1>
            <p class="subtitle lead">Another great addition in <code>tmap</code> 4</p>
                  <div>
        <div class="description">
          I still have reservations about the usability of bivariate choropleth maps, but at least it’s now a lot easier to make them!
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">tutorial</div>
                <div class="quarto-category">visualization</div>
                <div class="quarto-category">geospatial</div>
                <div class="quarto-category">cartography</div>
                <div class="quarto-category">tmap</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>David O’Sullivan </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 21, 2026</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#bivariate-choropleth-maps" id="toc-bivariate-choropleth-maps" class="nav-link active" data-scroll-target="#bivariate-choropleth-maps">Bivariate choropleth maps</a></li>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link" data-scroll-target="#preliminaries">Preliminaries</a>
  <ul class="collapse">
  <li><a href="#libraries-and-data" id="toc-libraries-and-data" class="nav-link" data-scroll-target="#libraries-and-data">Libraries and data</a></li>
  <li><a href="#tmap-or-ggplot2" id="toc-tmap-or-ggplot2" class="nav-link" data-scroll-target="#tmap-or-ggplot2"><code>tmap</code> or <code>ggplot2</code>?</a></li>
  </ul></li>
  <li><a href="#base-map-functions" id="toc-base-map-functions" class="nav-link" data-scroll-target="#base-map-functions">Base map functions</a></li>
  <li><a href="#adding-choropleths-univariate-and-bivariate" id="toc-adding-choropleths-univariate-and-bivariate" class="nav-link" data-scroll-target="#adding-choropleths-univariate-and-bivariate">Adding choropleths, univariate and bivariate</a></li>
  <li><a href="#bivariate-colour-palettes" id="toc-bivariate-colour-palettes" class="nav-link" data-scroll-target="#bivariate-colour-palettes">Bivariate colour palettes</a>
  <ul class="collapse">
  <li><a href="#sequential-sequential-schemes" id="toc-sequential-sequential-schemes" class="nav-link" data-scroll-target="#sequential-sequential-schemes">Sequential-sequential schemes</a></li>
  <li><a href="#other-kinds-of-data" id="toc-other-kinds-of-data" class="nav-link" data-scroll-target="#other-kinds-of-data">Other kinds of data</a></li>
  </ul></li>
  <li><a href="#back-to-making-maps" id="toc-back-to-making-maps" class="nav-link" data-scroll-target="#back-to-making-maps">Back to making maps</a>
  <ul class="collapse">
  <li><a href="#uncorrelated-variables" id="toc-uncorrelated-variables" class="nav-link" data-scroll-target="#uncorrelated-variables">Uncorrelated variables</a></li>
  <li><a href="#positively-correlated-variables" id="toc-positively-correlated-variables" class="nav-link" data-scroll-target="#positively-correlated-variables">Positively correlated variables</a></li>
  <li><a href="#negatively-correlated-variables" id="toc-negatively-correlated-variables" class="nav-link" data-scroll-target="#negatively-correlated-variables">Negatively correlated variables</a></li>
  </ul></li>
  <li><a href="#matched-univariate-and-bivariate-maps" id="toc-matched-univariate-and-bivariate-maps" class="nav-link" data-scroll-target="#matched-univariate-and-bivariate-maps">Matched univariate and bivariate maps</a></li>
  <li><a href="#final-thoughts" id="toc-final-thoughts" class="nav-link" data-scroll-target="#final-thoughts">Final thoughts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>This post started out intended to be an exploration of the modifiable areal unit problem (MAUP) as the next post in <a href="https://geospatialstuff.com/blog.html#category=geographic%20information%20analysis">my series of posts</a> supporting <a href="https://geospatialstuff.com/books.html"><em>Geographic Information Analysis</em></a>. Along the way I wanted to make some <em>bivariate choropleth maps</em> and lo… here we are. Bivariate maps in <code>tmap</code> turned into a bit of a rabbit hole, one worth exploring on its own. I’ll get back to the MAUP in due course.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<section id="bivariate-choropleth-maps" class="level2">
<h2 class="anchored" data-anchor-id="bivariate-choropleth-maps">Bivariate choropleth maps</h2>
<p>A bivariate choropleth blends two semi-transparent colour schemes, each independently representing a single variable. Mixes of the two colours can then be read (at least in theory) to give an overall sense of the spatial distribution of the two variables and how they are related. A <a href="https://www.joshuastevens.net/cartography/make-a-bivariate-choropleth-map/">good primer on the topic</a> has been provided by <a href="https://www.joshuastevens.net">Joshua Stevens</a>.</p>
<p>This approach to mapping two variables together in a map has been around for some time. There’s a chapter in <em>Visualization in Modern Cartography</em><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> by Cindy Brewer<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> that puts such colour schemes in a broader general scheme for classifying how colour can be used in maps. The cover of that book presented an example, not of a bivariate choropleth, but of mixing two colours to represent slope and aspect of terrain, based on an original idea presented by Moellering and Kimerling in 1990<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, later detailed further by Cindy Brewer and Ken Marlow in 1993.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<p>So the idea has been out there for well over 30 years. Arguably hillshading has always been an overlay of a second colour on any other colour symbolisation present in a particular map, but really that seems like a special case, and realistically, it’s only with the advent of computer graphics and the fairly routine fine-grained manipulation of colour that it’s become practical to make this kind of map easily enough to explore the possibilities the approach offers.</p>
<p><em>Fairly routine</em> and <em>easily enough</em> are doing a lot of work there. It’s really not been especially easy until very recently. The primer I linked to above requires quite a lot of manual work. This isn’t necessarily a bad thing—the last thing the world needs is lots of badly thought out bivariate choropleth maps. Nevertheless, it’s good to know that things have gotten easier lately, as this post will show.</p>
</section>
<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">Preliminaries</h2>
<section id="libraries-and-data" class="level3">
<h3 class="anchored" data-anchor-id="libraries-and-data">Libraries and data</h3>
<p>Mostly these are the usual suspects in terms of R libraries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-1"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-1-1"><a href="#annotated-cell-1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="annotated-cell-1-2"><a href="#annotated-cell-1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="annotated-cell-1-3"><a href="#annotated-cell-1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="annotated-cell-1-4"><a href="#annotated-cell-1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="annotated-cell-1-5"><a href="#annotated-cell-1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="1">1</button><span id="annotated-cell-1-6" class="code-annotation-target"><a href="#annotated-cell-1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(colorspace)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-1" data-target-annotation="2">2</button><span id="annotated-cell-1-7" class="code-annotation-target"><a href="#annotated-cell-1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cols4all)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-1" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="6" data-code-annotation="1"><a href="https://colorspace.r-forge.r-project.org/articles/colorspace.html"><code>colorspace</code></a> is useful for adjusting colours by lightening, darkening, and desaturating them.</span>
</dd>
<dt data-target-cell="annotated-cell-1" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-1" data-code-lines="7" data-code-annotation="2"><a href="https://cols4all.github.io/cols4all-R/"><code>cols4all</code></a> is essential for the wide array of colour palettes, including bivariate ones it provides.</span>
</dd>
</dl>
</div>
</div>
<p>And here’s some fairly generic New Zealand census data aggregated to ‘Statistical Area 2’ level (roughly neighbourhood size) for Christchurch. The data aren’t especially of interest, except as we’ll see that it’s useful to have some attributes with a range of correlations with one another as this can make for very different looking maps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>place <span class="ot">&lt;-</span> <span class="st">"Christchurch"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>alias <span class="ot">&lt;-</span> <span class="st">"chch"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">str_glue</span>(<span class="st">"{alias}-sa2-2018.gpkg"</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>context <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="fu">str_glue</span>(<span class="st">"{alias}-context.gpkg"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tmap-or-ggplot2" class="level3">
<h3 class="anchored" data-anchor-id="tmap-or-ggplot2"><code>tmap</code> or <code>ggplot2</code>?</h3>
<p>As ever in R, you have options, and for thematic mapping that invariably comes down to a choice between <a href="https://r-tmap.github.io/tmap/"><code>tmap</code></a> and <a href="https://ggplot2.tidyverse.org/"><code>ggplot2</code></a> (albeit with support from additional packages, in this case <a href="https://chris-prener.github.io/biscale/index.html"><code>biscale</code></a>). This is a topic I’ve <a href="https://geospatialstuff.com/30-day-maps-2023/">explored before</a>, <a href="https://geospatialstuff.com/posts/2024-11-16-tmap-vs-ggplot/tmap4-vs-ggplot2.html">more than once</a>.</p>
<p>In short, on this occasion, I came across the enhanced bivariate choropleth support in <code>tmap</code> version 4, when I was doing something else (that would be… working on a post about MAUP), and since that’s how I came to this topic I’ve chosen to run with it. As I’ve said before, both ecosystems are great, and I’m sure <code>biscale</code> is also a good choice for this approach to mapping.</p>
</section>
</section>
<section id="base-map-functions" class="level2">
<h2 class="anchored" data-anchor-id="base-map-functions">Base map functions</h2>
<p>I’ve chosen to make all the maps that follow using a common ‘base map’ with land and sea, a title, scale bar<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>, and the same set of lines delineating our map area boundaries. It’s convenient to wrap these elements in functions to standardise our maps. For the details of how the base map is constructed click into the code chunk below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>map_background <span class="ot">&lt;-</span> <span class="cf">function</span>(ctx) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(ctx, <span class="at">unit =</span> <span class="st">"km"</span>) <span class="sc">+</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_polygons</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="fu">lighten</span>(<span class="st">"lightgrey"</span>, <span class="fl">0.5</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> <span class="st">"lightblue"</span>) <span class="sc">+</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_title_in</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">text =</span> <span class="fu">str_glue</span>(<span class="st">"{place} 2018 Census SA2s"</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">bg =</span> <span class="cn">TRUE</span>, <span class="at">bg.color =</span> <span class="st">"#ffffffa0"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">position =</span> <span class="fu">tm_pos_in</span>(<span class="at">pos.h =</span> <span class="st">"left"</span>, <span class="at">pos.v =</span> <span class="st">"bottom"</span>)) <span class="sc">+</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_scalebar</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">bg.color =</span> <span class="fu">desaturate</span>(<span class="st">"lightblue"</span>, <span class="fl">0.35</span>), </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">inner.margins =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>map_boundaries <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(df) <span class="sc">+</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_lines</span>(<span class="at">col =</span> <span class="st">"lightgrey"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="fu">map_background</span>(context) <span class="sc">+</span> <span class="fu">map_boundaries</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-basemap" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-basemap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-basemap-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: A simple base map ready for choropleth areas to be added."><img src="index_files/figure-html/fig-basemap-1.png" class="img-fluid figure-img" width="624"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-basemap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: A simple base map ready for choropleth areas to be added.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="adding-choropleths-univariate-and-bivariate" class="level2">
<h2 class="anchored" data-anchor-id="adding-choropleths-univariate-and-bivariate">Adding choropleths, univariate and bivariate</h2>
<p>With base map built we can focus on the choropleth mapping.</p>
<p>First, a simple univariate example, just to show the standard <code>tmap</code> approach to specifying a colour scale. We invoke <code>tm_fill()</code> to specify the variables to be symbolised by the colour fill, and establish the mapping between the data and the fill values using <code>tm_scale_intervals()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_background</span>(context) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(df) <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"pc_yadult"</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill.scale =</span> <span class="fu">tm_scale_intervals</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">style =</span> <span class="st">"quantile"</span>, <span class="at">n =</span> <span class="dv">5</span>, <span class="at">values =</span> <span class="st">"brewer.reds"</span>)) <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_boundaries</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-univariate-choropleth-map" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-univariate-choropleth-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-univariate-choropleth-map-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: A simple univariate choropleth map."><img src="index_files/figure-html/fig-univariate-choropleth-map-1.png" class="img-fluid figure-img" width="720"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-univariate-choropleth-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: A simple univariate choropleth map.
</figcaption>
</figure>
</div>
</div>
</div>
<p>I’m not too concerned here with the niceties of the map layout for now. Of more interest is what happens when you specify more than one variable for the <code>fill</code> parameter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_background</span>(context) <span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(df) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"pc_yadult"</span>, <span class="st">"pc_pakeha"</span>), </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill.scale =</span> <span class="fu">tm_scale_intervals</span>(<span class="at">style =</span> <span class="st">"quantile"</span>, <span class="at">values =</span> <span class="st">"brewer.reds"</span>)) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_boundaries</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-two-variables-facetted" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-two-variables-facetted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-two-variables-facetted-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: The result of specifying more than one variable for the fill parameter."><img src="index_files/figure-html/fig-two-variables-facetted-1.png" class="img-fluid figure-img" width="960"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-two-variables-facetted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The result of specifying more than one variable for the <code>fill</code> parameter.
</figcaption>
</figure>
</div>
</div>
</div>
<p>OK… that’s interesting. We get a faceted two panel map, one facet for each of the specified variables. This is a really nice feature of <code>tmap</code> that’s explained in some detail <a href="https://r-tmap.github.io/tmap/articles/basics_facets">here</a>. You don’t have to stick with the same colour palette for each variable, and can symbolise each of them differently. But that’s not our current focus.</p>
<p>As an aside, and for what it’s worth, this is definitely an area where <code>tmap</code> has a clear advantage over <code>ggplot2</code>. Faceting based on each facet representing a different variable in <code>ggplot2</code> requires using <code>tidyr::pivot_longer</code> to make what amounts to a geographic dataset where the map areas are repeated as many times as you have variables.</p>
<p>But I digress. It turns out there is another way to specify more than one variable, using <code>fill = tm_vars()</code>, and by specifying the <code>multivariate = TRUE</code> option, this allows us to make bivariate choropleths (although the <code>tm_vars()</code> function help doesn’t make this especially obvious).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_background</span>(context) <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(df) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_fill</span>(<span class="at">fill =</span> <span class="fu">tm_vars</span>(<span class="fu">c</span>(<span class="st">"pc_yadult"</span>, <span class="st">"pc_pakeha"</span>), <span class="at">multivariate =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_boundaries</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-minimal-bivariate-choropleth" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-minimal-bivariate-choropleth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-minimal-bivariate-choropleth-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: A minimal bivariate choropleth example."><img src="index_files/figure-html/fig-minimal-bivariate-choropleth-1.png" class="img-fluid figure-img" width="624"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-minimal-bivariate-choropleth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: A minimal bivariate choropleth example.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Even more interesting! Of course this example chooses defaults for the colours, and the classification scheme for each variable. We can refine the map using <code>tm_scale_bivariate()</code> and <code>tm_legend_bivariate()</code> functions.</p>
<p>I’ve wrapped these options in a function below so we can explore the possibilities. The <code>values</code> parameter of <code>tm_scale_bivariate</code> specifies a bivariate colour palette to use, while <code>scale1</code> and <code>scale2</code> specify the mapping between each variable and its associated color ramp. To keep things manageable, I’ve gone with quartile schemes for both variables. This also helps with getting output maps that make maximal use of the colour palettes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a>map_two_variables <span class="ot">&lt;-</span> <span class="cf">function</span>(ctx, df, </span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>                              var1, var2, alias1, alias2,</span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">pal =</span> <span class="st">"cols4all.pu_gn_bivs"</span>) {</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_background</span>(ctx) <span class="sc">+</span></span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_shape</span>(df) <span class="sc">+</span></span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_fill</span>(</span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> <span class="fu">tm_vars</span>(<span class="fu">c</span>(var1, var2), <span class="at">multivariate =</span> <span class="cn">TRUE</span>),</span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill.scale =</span> <span class="fu">tm_scale_bivariate</span>(</span>
<span id="annotated-cell-7-9"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c4a</span>(pal),</span>
<span id="annotated-cell-7-10"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale1 =</span> <span class="fu">tm_scale_intervals</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-11" class="code-annotation-target"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">style =</span> <span class="st">"quantile"</span>, <span class="at">n =</span> <span class="dv">4</span>, <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Q"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">sep =</span> <span class="st">""</span>)),</span>
<span id="annotated-cell-7-12"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">scale2 =</span> <span class="fu">tm_scale_intervals</span>(</span>
<span id="annotated-cell-7-13"><a href="#annotated-cell-7-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">style =</span> <span class="st">"quantile"</span>, <span class="at">n =</span> <span class="dv">4</span>, <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">"Q"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">sep =</span> <span class="st">""</span>))),</span>
<span id="annotated-cell-7-14"><a href="#annotated-cell-7-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill.legend =</span> <span class="fu">tm_legend_bivariate</span>(</span>
<span id="annotated-cell-7-15"><a href="#annotated-cell-7-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">text.size =</span> <span class="fl">0.8</span>, <span class="at">bg.color =</span> <span class="st">"#ffffffa0"</span>,</span>
<span id="annotated-cell-7-16"><a href="#annotated-cell-7-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">position =</span> <span class="fu">tm_pos_in</span>(<span class="at">pos.h =</span> <span class="st">"left"</span>, <span class="at">pos.v =</span> <span class="st">"top"</span>),</span>
<span id="annotated-cell-7-17"><a href="#annotated-cell-7-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">item.r =</span> <span class="dv">0</span>, <span class="at">item.width =</span> <span class="fl">1.4</span>, <span class="at">item.height =</span> <span class="fl">1.4</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-18" class="code-annotation-target"><a href="#annotated-cell-7-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> alias2, <span class="at">ylab =</span> alias1)) <span class="sc">+</span></span>
<span id="annotated-cell-7-19"><a href="#annotated-cell-7-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_boundaries</span>(df)</span>
<span id="annotated-cell-7-20"><a href="#annotated-cell-7-20" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="11" data-code-annotation="1">I’ve specified legend labels Q1, Q2, … for quartile 1, quartile 2, etc., because getting more informative numerical ranges to work well is not a solved problem at this stage (see <a href="#fig-minimal-bivariate-choropleth" class="quarto-xref">Figure&nbsp;4</a> for an example.)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="18" data-code-annotation="2">Note the inversion of the x and y axis of the palette label ordering. This was a source of much confusion to me.</span>
</dd>
</dl>
</div>
</div>
<p>Here’s an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_two_variables</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  context, df, <span class="st">"pc_yadult"</span>, <span class="st">"pc_pakeha"</span>, <span class="st">"%Young adult"</span>, <span class="st">"%Pākehā"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-using-map-two-variables" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-using-map-two-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-using-map-two-variables-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: Example map produced using the map_two_variables function."><img src="index_files/figure-html/fig-using-map-two-variables-1.png" class="img-fluid figure-img" width="873"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-using-map-two-variables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Example map produced using the <code>map_two_variables</code> function.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="bivariate-colour-palettes" class="level2">
<h2 class="anchored" data-anchor-id="bivariate-colour-palettes">Bivariate colour palettes</h2>
<p>Bivariate colour palettes are non-trivial to design. Mixing colours is difficult to control and can produce unexpected effects.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> This has led, I think, to a conservatism in the options recommended.</p>
<p>To show this, requires a slight digression back to <code>ggplot2</code> to make a handy dandy<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> cheat sheet for the sequential-sequential bivariate palettes available in <code>cols4all</code>.</p>
<p>Click into the code cell below for a function that returns a plot of a bivariate colour palette (itself a matrix of hex coded colours) as a <code>ggplot2</code> object. The function includes some additional ‘wrinkles’, particularly the option to rescale the grid to a specified range of values, so that we can use these palette plots as a background for scatter plots later in this post.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>get_coords <span class="ot">&lt;-</span> <span class="cf">function</span>(n, limits) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  base_coords <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>(n <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> scales<span class="sc">::</span><span class="fu">rescale</span>(<span class="at">to =</span> limits)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  base_coords[<span class="fu">seq</span>(<span class="dv">2</span>, n <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">2</span>)]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>get_palette_grid <span class="ot">&lt;-</span> <span class="cf">function</span>(pal, <span class="at">n =</span> <span class="cn">NA</span>, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">show_text =</span> <span class="cn">TRUE</span>, <span class="at">textsize =</span> <span class="dv">7</span>, </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">limits =</span> <span class="cn">NULL</span>) {</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  colour_matrix <span class="ot">&lt;-</span> <span class="fu">c4a</span>(pal, n)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(limits)) {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    xs <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(colour_matrix)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    ys <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(colour_matrix)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    xs <span class="ot">&lt;-</span> <span class="fu">get_coords</span>(<span class="fu">nrow</span>(colour_matrix), limits)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    ys <span class="ot">&lt;-</span> <span class="fu">get_coords</span>(<span class="fu">ncol</span>(colour_matrix), limits)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand_grid</span>(<span class="at">x =</span> xs, <span class="at">y =</span> ys) <span class="sc">|&gt;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hex =</span> <span class="fu">c</span>(colour_matrix)) <span class="sc">|&gt;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_raster</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> hex)) <span class="sc">+</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_identity</span>() <span class="sc">+</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">ifelse</span>(show_text, pal, <span class="st">""</span>)) <span class="sc">+</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> textsize, <span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now let’s see what we’ve got.</p>
<section id="sequential-sequential-schemes" class="level3">
<h3 class="anchored" data-anchor-id="sequential-sequential-schemes">Sequential-sequential schemes</h3>
<p>These schemes are the ones most relevant to us here, as they are based on mixing two sequential colour ramps each of which can represent a numeric attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c4a_palettes</span>(<span class="at">type =</span> <span class="st">"bivs"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(get_palette_grid, <span class="at">n =</span> <span class="dv">4</span>, <span class="at">textsize =</span> <span class="dv">8</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">wrap_plots</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-sequential-sequential-schemes" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sequential-sequential-schemes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-sequential-sequential-schemes-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;6: The sequential-sequential palettes available in cols4all."><img src="index_files/figure-html/fig-sequential-sequential-schemes-1.png" class="img-fluid figure-img" width="864"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sequential-sequential-schemes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: The sequential-sequential palettes available in <code>cols4all</code>.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The first nine of these are more ‘traditional’. The remainder are from <a href="https://kamilraczycki.com/">Kamil Raczycki’s</a> <a href="https://github.com/RaczeQ/bivario">bivario python module</a>, and are a lot more colourful!<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<p>How well these more garish palettes work in making readable maps is unclear, but I say, “the more the merrier” and let’s see where we end up.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> In preparing this post I found the less reserved <code>bivario</code> schemes useful in avoiding clashes with even the muted background colours I’ve used in my maps. Admittedly, Joshua Stevens is explicit that his schemes are suited to a white background, and you can see why, given their pale, slightly washed out colours.</p>
</section>
<section id="other-kinds-of-data" class="level3">
<h3 class="anchored" data-anchor-id="other-kinds-of-data">Other kinds of data</h3>
<p><code>cols4all</code> also offers an array of sequential-diverging, sequential-categorical, and ‘sequential-desaturated’ palettes. I recommend viewing those using the <code>cols4all::c4a_gui()</code> function, which allows you to interactively explore all these palettes and the many, <em>many</em> more conventional palettes <code>cols4all</code> supports. For what it’s worth in most cases these palettes combine a set of categorical colours with a sequence of levels of intensity or saturation. For example, here is <code>tableau.classic20_biv</code>:</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-tableau-classic20-biv" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tableau-classic20-biv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-tableau-classic20-biv-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;7: A typical sequential-categorial bivariate palette."><img src="index_files/figure-html/fig-tableau-classic20-biv-1.png" class="img-fluid figure-img" width="480"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tableau-classic20-biv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: A typical sequential-categorial bivariate palette.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="back-to-making-maps" class="level2">
<h2 class="anchored" data-anchor-id="back-to-making-maps">Back to making maps</h2>
<p>It’s interesting to examine how bivariate choropleth maps look given two variables that are uncorrelated, positively correlated, or negatively correlated.</p>
<p>Because we are using a quantile classification to make the maps, the relevant measure of correlation is <a href="https://en.wikipedia.org/wiki/Spearman's_rank_correlation_coefficient">Spearman’s rank</a>. Inspection of the data shows that the <code>pc_asian</code> (%Asian) variable is suitably related to the <code>pc_pacific</code> (%Pacific people), <code>pc_yadult</code> (%Young adult) and <code>pc_pakeha</code> (%Pākehā) variables, respectively:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(df <span class="sc">|&gt;</span> <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="dv">13</span>, <span class="dv">12</span>, <span class="dv">14</span>, <span class="dv">10</span>),</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"spearman"</span>)[<span class="dv">1</span>, ] <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  pc_asian pc_pacific  pc_yadult  pc_pakeha 
    1.0000     0.1273     0.6819    -0.8853 </code></pre>
</div>
</div>
<p>So, now we can examine maps of these combinations of variables and see what we get.</p>
<section id="uncorrelated-variables" class="level3">
<h3 class="anchored" data-anchor-id="uncorrelated-variables">Uncorrelated variables</h3>
<p>For this and the subsequent maps, I have gone with the <code>bivario.blade_runner</code> palette.<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="st">"bivario.blade_runner"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">map_two_variables</span>(context, df, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"pc_asian"</span>, <span class="st">"pc_pacific"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"%Asian"</span>, <span class="st">"%Pacific people"</span>, pal)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">get_palette_grid</span>(pal, <span class="dv">4</span>, <span class="at">show_text =</span> <span class="cn">FALSE</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(df))) <span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">rank</span>(pc_pacific), <span class="at">y =</span> <span class="fu">rank</span>(pc_asian)), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Rank %Pacific people"</span>) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Rank %Asian"</span>) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>())</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(<span class="fu">list</span>(<span class="fu">tmap_grob</span>(m1), p1), <span class="at">widths =</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-uncorrelated-pair" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-uncorrelated-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-uncorrelated-pair-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;8: Bivariate choropleth of two variables that are weakly correlated with a scatterplot showing the distribution of the data overplotted on the colour palette."><img src="index_files/figure-html/fig-uncorrelated-pair-1.png" class="img-fluid figure-img" width="1152"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-uncorrelated-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Bivariate choropleth of two variables that are weakly correlated with a scatterplot showing the distribution of the data overplotted on the colour palette.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="positively-correlated-variables" class="level3">
<h3 class="anchored" data-anchor-id="positively-correlated-variables">Positively correlated variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">map_two_variables</span>(context, df, </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"pc_asian"</span>, <span class="st">"pc_yadult"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"%Asian"</span>, <span class="st">"%Young adult"</span>, pal)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">get_palette_grid</span>(pal, <span class="dv">4</span>, <span class="at">show_text =</span> <span class="cn">FALSE</span>, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(df))) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">rank</span>(pc_asian), <span class="at">y =</span> <span class="fu">rank</span>(pc_yadult)), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Rank %Young adult"</span>) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Rank %Asian"</span>) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>())</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(<span class="fu">list</span>(<span class="fu">tmap_grob</span>(m2), p2), <span class="at">widths =</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-positively-correlated-pair" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-positively-correlated-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-positively-correlated-pair-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9" title="Figure&nbsp;9: Bivariate choropleth of two variables that are positively correlated with a scatterplot showing the distribution of the data overplotted on the colour palette."><img src="index_files/figure-html/fig-positively-correlated-pair-1.png" class="img-fluid figure-img" width="1152"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-positively-correlated-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Bivariate choropleth of two variables that are positively correlated with a scatterplot showing the distribution of the data overplotted on the colour palette.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="negatively-correlated-variables" class="level3">
<h3 class="anchored" data-anchor-id="negatively-correlated-variables">Negatively correlated variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">map_two_variables</span>(context, df, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"pc_asian"</span>, <span class="st">"pc_pakeha"</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"%Asian"</span>, <span class="st">"%Pākehā"</span>, pal)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">get_palette_grid</span>(pal, <span class="dv">4</span>, <span class="at">show_text =</span> <span class="cn">FALSE</span>, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(df))) <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df, </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">rank</span>(pc_pakeha), <span class="at">y =</span> <span class="fu">rank</span>(pc_asian)), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Rank %Pākehā"</span>) <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Rank %Asian"</span>) <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>())</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(<span class="fu">list</span>(<span class="fu">tmap_grob</span>(m3), p3), <span class="at">widths =</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-negatively-correlated-pair" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-negatively-correlated-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-negatively-correlated-pair-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;10: Bivariate choropleth of two variables that are negatively correlated with a scatterplot showing the distribution of the data overplotted on the colour palette."><img src="index_files/figure-html/fig-negatively-correlated-pair-1.png" class="img-fluid figure-img" width="1152"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-negatively-correlated-pair-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Bivariate choropleth of two variables that are negatively correlated with a scatterplot showing the distribution of the data overplotted on the colour palette.
</figcaption>
</figure>
</div>
</div>
</div>
<p>What I hope these plots show is how the overall mix of colours present in the bivariate maps can (with practice!) give an immediate clue to the correlation between the mapped variables. Uncorrelated variables pull colours from all over the palette, while positively and negatively correlated variables pull colours from opposing diagonals of the palette. In these examples, this effect is particularly apparent in the last map where colours from the upper left and lower right of the palette predominate. Areas with a relatively large Asian population presence (in the centre city and around the university to the west) have relatively low Pākehā (New Zealand European) population presence and vice-versa.</p>
</section>
</section>
<section id="matched-univariate-and-bivariate-maps" class="level2">
<h2 class="anchored" data-anchor-id="matched-univariate-and-bivariate-maps">Matched univariate and bivariate maps</h2>
<p>In exploring the possibilities presented by these maps, I have found it helpful to make univariate maps with matched colour ramps for the two variables being combined. Code in the cell below shows how this can be done based on the <code>cols4all</code> bivariate palettes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>get_palette_first_col_or_row <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">pal =</span> <span class="st">"bivario.plum_mint"</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">column =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (column) {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c4a</span>(pal)[, <span class="dv">1</span>])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">c4a</span>(pal)[<span class="dv">1</span>, ])</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>map_one_variable <span class="ot">&lt;-</span> <span class="cf">function</span>(ctx, df, var, alias, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">pal =</span> <span class="st">"bivario.plum_mint"</span>, </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                             <span class="at">column =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_background</span>(ctx) <span class="sc">+</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_shape</span>(df) <span class="sc">+</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_fill</span>(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> var,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill.scale =</span> <span class="fu">tm_scale_intervals</span>(</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">style =</span> <span class="st">"quantile"</span>, <span class="at">n =</span> <span class="dv">4</span>, </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">get_palette_first_col_or_row</span>(<span class="at">pal =</span> pal, <span class="at">column =</span> column)),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill.legend =</span> <span class="fu">tm_legend</span>(</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">item.r =</span> <span class="dv">0</span>, <span class="at">item.width =</span> <span class="fl">1.4</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> alias, <span class="at">bg.color =</span> <span class="st">"#ffffffa0"</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">frame =</span> <span class="cn">FALSE</span>, <span class="at">position =</span> <span class="fu">tm_pos_in</span>(<span class="at">pos.h =</span> <span class="st">"left"</span>, <span class="at">pos.v =</span> <span class="st">"top"</span>))) <span class="sc">+</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_boundaries</span>(df)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To use this function, depending on which of the two attributes we are working with we specify that the univariate colour palette should be from the first column (<code>column = TRUE</code>) or row (<code>column = FALSE</code>) of the supplied bivariate colour ramp.</p>
<p>The two univariate maps that correspond to the bivariate map of %Asian and %Young adult population and the combined map are shown below. If you click on one of them, a zoomed in view will show, and you can slide between the three maps, and hopefully see how the variables are combined by colour overlay.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-combining-univariate-maps-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-combining-univariate-maps-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-combining-univariate-maps-1.png" class="lightbox" data-gallery="mix-maps" title="Figure&nbsp;11: Univariate map 1."><img src="index_files/figure-html/fig-combining-univariate-maps-1.png" class="img-fluid figure-img" width="873"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-combining-univariate-maps-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Univariate map 1.
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-combining-univariate-maps-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-combining-univariate-maps-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-combining-univariate-maps-2.png" class="lightbox" data-gallery="mix-maps" title="Figure&nbsp;12: Univariate map 2."><img src="index_files/figure-html/fig-combining-univariate-maps-2.png" class="img-fluid figure-img" width="873"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-combining-univariate-maps-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Univariate map 2.
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-combining-univariate-maps-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-combining-univariate-maps-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="index_files/figure-html/fig-combining-univariate-maps-3.png" class="lightbox" data-gallery="mix-maps" title="Figure&nbsp;13: Combined bivariate map."><img src="index_files/figure-html/fig-combining-univariate-maps-3.png" class="img-fluid figure-img" width="873"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-combining-univariate-maps-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Combined bivariate map.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final thoughts</h2>
<p>As I mentioned at the top bivariate choropleth maps have been around for some time, but it has only recently become easy to make them. That’s not necessarily a <em>bad</em> thing given the complexities of making use of the technique to convey data effectively. Nevertheless, it can only be a good thing that it’s now a lot easier to make such maps, and hopefully that ease will advance our understanding of what works and doesn’t work in this challenging design space.</p>
<p>Based on my (relatively limited) experience putting this post together and some past experiments with the method, it is instructive to see the univariate maps that combined to make a bivariate one, to help in interpreting the maps you are making, and also in developing your ability to read such maps.</p>
<p>As someone who is generally fairly conservative with colour choices, I have found it interesting how compelling the more vibrant <code>bivario</code> colour palettes are (at least for me). I’d be interested to hear other opinions on this point.</p>
<p>Finally, if you want to map <em>more</em> than two variables consider my <a href="https://github.com/DOSull/weaving-space"><code>weavingspace</code></a> python module or its associated <a href="https://geospatialstuff.com/mapweaver/app">MapWeaver web app</a>, where we approach the challenge of combining multiple colour ramps in a rather different way!</p>


</section>


<p><a href="../../"><img src="../../images/gs-logo-corrected.png" style="height:36px;" alt="Geospatial Stuff"></a></p><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>If you’re desperate, there are posts <a href="https://computinggeographically.org/chapters/chap5/fig5-06-simple-maup.html">here</a> and <a href="https://computinggeographically.org/chapters/chap5/fig5-07-maup-aggregation.html">here</a> to keep you occupied for the time being.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>MacEachren AM, and DRF Taylor (eds.) 1994. <em>Visualization in Modern Cartography</em>. Pergamon.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Brewer CA. 1994. Color use guidelines for mapping and visualization. Pages 123-147 in <em>Visualization in Modern Cartography</em>, AM MacEachren, DRF Taylor (eds.). Pergamon.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Moellering, H, and JA Kimerling (1990). <a href="https://dx.doi.org/10.1559/152304090783813853">A New Digital Slope-Aspect Display Process</a>. <em>Cartography and Geographic Information Systems</em> <strong>17</strong>(2) 151–159.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Brewer CA and KA Marlow. 1993. <a href="https://cartogis.org/docs/proceedings/archive/auto-carto-11/pdf/color-representation-of-aspect-and-slope-simultaneously.pdf">Color representation of aspect and slope simultaneously</a> pages 328-337 in RB McMaster and MP Armstrong (eds.) <em>Auto-Carto 11 Proceedings of the International Symposium On Computer-Assisted Cartography</em>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Anyone who knows me will realise this has been added somewhat grudgingly<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Most of them a muddy brown.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Thank you <a href="https://en.wikipedia.org/wiki/Blue%27s_Clues"><em>Blue’s Clues</em></a> for lodging that phrase in my early parenting brain back in the early years of this century.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>They also have much wilder names…<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>I’m skeptical about the usefulness of <code>kaleidoscope</code>, but then, cartographers and rainbows rarely get along.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>Seriously, how could I not?!<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:\/\/|https:\/\/)(?:dosull\.github\.io|geospatialstuff\.com|southosullivan\.com|github\.com\/DOSull|southosullivan\.com|patternandprocess\.org|computinggeographically\.org)");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":true,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>